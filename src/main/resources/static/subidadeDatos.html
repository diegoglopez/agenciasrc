<!DOCTYPE html>
<html lang="en">
    <head>
        <link rel="icon" type="image/x-icon" href="image/favicon.ico" />
        <meta charset="utf-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
        <meta name="description" content="" />
        <meta name="author" content="" />
        <title>i/o Data</title>
        <link href="https://cdn.jsdelivr.net/npm/simple-datatables@latest/dist/style.css" rel="stylesheet" />
        <link href="css/styles.css" rel="stylesheet" />
        <script src="https://use.fontawesome.com/releases/v6.1.0/js/all.js" crossorigin="anonymous"></script>
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    </head>
    <body class="sb-nav-fixed">
        <nav class="sb-topnav navbar navbar-expand navbar-dark bg-dark">
            <!-- Navbar Brand-->
            <a class="navbar-brand ps-3" href="index.html">Bienvenido!</a>
            <!-- Sidebar Toggle-->
            <button class="btn btn-link btn-sm order-1 order-lg-0 me-4 me-lg-0" id="sidebarToggle" href="#!"><i class="fas fa-bars"></i></button>
            <!-- Navbar Search-->
            <form class="d-none d-md-inline-block form-inline ms-auto me-0 me-md-3 my-2 my-md-0">
            </form>
            <!-- Navbar-->
            <ul class="navbar-nav ms-auto ms-md-0 me-3 me-lg-4">
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" id="navbarDropdown" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false"><i class="fas fa-user fa-fw"></i></a>
                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdown">
                        <li><a class="dropdown-item" href="#!">Settings</a></li>
                        <li><a class="dropdown-item" href="#!">Activity Log</a></li>
                        <li><hr class="dropdown-divider" /></li>
                        <li><a class="dropdown-item" href="#!">Logout</a></li>
                    </ul>
                </li>
            </ul>
        </nav>
        
        <div id="layoutSidenav">
            
            <div id="layoutSidenav_nav">
                <nav class="sb-sidenav accordion sb-sidenav-dark" id="sidenavAccordion">
                    <div class="sb-sidenav-menu">
                        <div class="nav">
                            <div class="sb-sidenav-menu-heading">Menú</div>
                            <a class="nav-link" href="index.html">
                                <div class="sb-nav-link-icon"><i class="fas fa-tachometer-alt"></i></div>
                                Exportar de datos
                            </a>
                            <a class="nav-link" href="subidadeDatos.html">
                                <div class="sb-nav-link-icon"><i class="fas fa-chart-area"></i></div>
                                Importación data
                            </a>
                        </div>
                    </div>
                    <div class="sb-sidenav-footer">
                        <!-- <div class="small">Logueado como:</div>
                        Usuario Test -->
                    </div>
                </nav>
            </div>
            
            
            <div id="layoutSidenav_content" style="background-color: #f8f9fa">
                <main>
                    <div class="container px-5 mt-4 mb-4">
                        <div class="row ">
                            <div class=" col-lg-12 mt-4 mb-3">
                                <h1>Importación de Datos de Cartera</h1>
                            </div>
                        </div>
                        <div class="row ">
                            <div class=" col-lg-6 mt-4 mb-3">
                                <select id="selectList" class="form-select me-3">
                                  <!-- Las opciones se cargarán dinámicamente -->
                                </select>
                            </div>
                            <div class=" col-lg-6 mt-4 mb-3">
                                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#myModal">
                                  Nueva Fuente
                                </button>
                            </div>
                        </div>
                        
                        
                        <div>
                            
                        </div>
                        
                        <div class="row gx-5 align-items-center">
                            
                            <br>
                            <div class="card col-lg-12 card-body mb-3">
                                <div id="mensaje" class="mb-3"></div>
                                <!-- Mashead text and app badges-->
                                <div class="mb-5 mb-lg-0 text-center text-lg-start">
                                    <h5 class="display-6 lh-1 mb-3" >Arrastre o seleccione el archivo a importar</h5>
                                   
                                    <div class="d-flex flex-column flex-lg-row align-items-center">
                                        <!-- <a class="me-lg-3 mb-4 mb-lg-0" href="#!"><img class="app-badge" src="assets/img/google-play-badge.svg" alt="..." /></a> -->
                                        <!-- <a href="#!"><img class="app-badge" src="assets/img/app-store-badge.svg" alt="..." /></a> -->
                                    </div>
                                </div>
                                <div>
                                    <form id="importacionMP"  class="form-control input ng-invalid ng-untouched ng-pristine"  enctype="multipart/form-data">
                                        <div _ngcontent-gxt-c125="" ng2filedrop="" tabindex="0" class="well upload-file ng-star-inserted">
                                            <div _ngcontent-gxt-c125="" class="d-flex flex-column align-items-center">
                                                <su-icon _ngcontent-gxt-c125="" color="#999999" name="icon-b-FUNC132--clouds_upload" size="2rem" _nghost-gxt-c42=""><span _ngcontent-gxt-c42="" class="icon icon-b-FUNC132--clouds_upload" style="font-size: 2rem; color: rgb(153, 153, 153);"></span></su-icon>
                                                <label _ngcontent-gxt-c125="" class="">Seleccione o arrastre dentro del recuadro</label>
                                                <label _ngcontent-gxt-c125="" class="" for="1-0">Archivos de tipo Excel con los casos a generar</label>
                                                <br>
                                                    <input id="idfile" tabindex="-1" type="file" class="form-control input hidden-input" accept="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel" required >
                                                    </div></div><!---->
                                                    <div _ngcontent-gxt-c125="" class="fileUpload-info-message">
                                                        <p _ngcontent-gxt-c125="" class="fileUpload-info-message-paragraph"></p>
                                                    </div>
                                                    <div _ngcontent-gxt-c125="" class="upload-file-components ng-star-inserted">
                                                        <ul _ngcontent-gxt-c125="" class="list-inline"><!---->
                                                            <div _ngcontent-gxt-c125="" class="progress" hidden="">
                                                    <div _ngcontent-gxt-c125="" role="progressbar" class="progress-bar" style="width: 0%;"> -1% 
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <br>
                                        <div class="mb-3" style="padding-left: 10px;" >
                                            <button id="btnGL" type="submit" class="btn primary-orange rounded-pill px-3 mb-3 mb-lg-2" style="width: 25rem; padding: 10px; ">Subir  </button>
                                        </div>
                                        <div id="barraprogreso" style="display: none;">
                                            <div class="progress">
                                                <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" aria-valuenow="75" aria-valuemin="0" aria-valuemax="100" style="width: 50%"></div>
                                            </div>
                                        </div>
                                    </form>
                                        
                                </div>
                        </div>
                    </div>
                    
                </main>
                
                <footer class="py-4 bg-light mt-auto">
                    <div class="container-fluid px-4">
                        <div class="d-flex align-items-center justify-content-between small">
                            <div class="text-muted">Copyright &copy; DGL WebSite</div>
                            <div>
                                <a href="#">Privacy Policy</a>
                                &middot;
                                <a href="#">Terms &amp; Conditions</a>
                            </div>
                        </div>
                        <div >
                            
                        </div>
                    </div>
                </footer>
            </div>
            <!-- Modal -->
        <div class="modal fade" id="myModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
            <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">Nombre de la Nueva Fuente</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                <input type="text" id="textInput" class="form-control" placeholder="Ingrese el nombre">
                </div>
                <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="guardarTexto()">Guardar</button>
                </div>
            </div>
            </div>
        </div>
        </div>
        

        <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.3/js/bootstrap.bundle.min.js"></script>

        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
        <script src="js/scripts.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.8.0/Chart.min.js" crossorigin="anonymous"></script>
        <script src="assets/demo/chart-area-demo.js"></script>
        <script src="assets/demo/chart-bar-demo.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/simple-datatables@latest" crossorigin="anonymous"></script>
        <script src="js/datatables-simple-demo.js"></script>
        <script src="js/dataconfiguration.js"></script>
    </body>
    
  
</html>
<script>
    $(document).ready(function() {
      cargarLista();
    });

    function cargarLista() {
      var url =  SERVER +  "/proveedores/getAll";
      $.get(url, function(data) {
        var selectList = $("#selectList");
        selectList.empty();
        $.each(data, function(index, item) {
          selectList.append($('<option>', {
            value: item.id,
            text: item.descripcion
          }));
        });
      });
    }

    $('#selectList').change(onChangeLista);
    var selectedId = 0;
    function onChangeLista() {
        selectedId = $('#selectList').val(); // Obtener el valor seleccionado
    }

    function guardarTexto() {
        var texto = document.getElementById("textInput").value;
        var selectValue = document.getElementById("selectList").value;

        var data = {
            descripcion: texto
        };

        $.ajax({
            url: SERVER + "/proveedores/create",
            type: "POST",
            contentType: "application/json",
            data: JSON.stringify(data),
            success: function(response) {
                console.log("Nuevo elemento guardado:", response);
                document.getElementById("textInput").value = "";
                location.reload();
            },
            error: function(error) {
                console.error("Error al guardar el nuevo elemento:", error);
                // Manejar el error de acuerdo a tus necesidades
            }
        });
    }
    var btnimportar = document.getElementById("importacionMP");
    var fileInput = document.getElementById("idfile");
    /****** 
     * 
     * Subida de datos EXCEL
     * 
     * 
    **/
    
    function disablebutton(){
        $("#btnGL").prop('disabled', true);
    }
    function enablebutton(){
        $("#btnGL").prop('disabled', false);
    }


    btnimportar.onsubmit = (e) => {
        e.preventDefault();
        disablebutton();
        $("#barraprogreso").show("fast");
        
        form = new FormData();
        form.append("file",  fileInput.files[0], fileInput.files[0].name);
        enviarExcel2();
        // $("#barraprogreso").hide("fast");
    }

    function enviarExcel2(){
        $('#mensaje').val('');
        $.ajax( {
           url: SERVER + "/importacionCartera/upload",
           type: 'POST',
           data: form,
           timeout: 0,
           processData: false,
           contentType: false,
           mimeType: "multipart/form-data",
           headers: {
                'IdProveedor': selectedId,
                'Access-Control-Allow-Origin': SERVER
            },
           success: function (data, textStatus, jqXHR) {
                var jsonParseado = JSON.parse(data);
                if(jsonParseado.errores.length > 0 ){
                    erroresList=jsonParseado.errores;
                    
                } 
                finalizar();
              
           },
           error: function (err) {
                alert("Ocurrio un error inesperado, contacte al administrador");
                $("#idfile").val("");
                fc_showAlertmensaje("mensaje","danger","No pudo completarse la solicitud"," \nRevise el archivo adjunto, pruebe con otro o contacte al administrador");
                enablebutton();
                $("#barraprogreso").hide("fast");
                var jsonErrorParseado = JSON.parse(err);
                console.log(jsonErrorParseado);
            }
        });
    } 

    function finalizar(){
        $("#barraprogreso").hide("fast");
        enablebutton();
        fc_showAlertmensaje("mensaje","success","Importacion terminada correctamente!","");
        $('#idfile').val('');
    } 

    

</script>
